// Prisma schema for ScoreSnap MVP + Press Box AI + Supabase Integration
// 7 models: User, Submission, Game, ValidationError, EditHistory, Conversation, Article

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl removed - was causing env loading issues with bunx
}

// ========================================
// EXISTING SUPABASE MODELS (Reference Only)
// ========================================
// Uncomment when you need to work with schools directly

// model School {
//   id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
//   key             String    @unique
//   name            String
//   city            String?
//   classification  String?
//   conference      String?
//   createdAt       DateTime  @default(now()) @map("created_at")
//   updatedAt       DateTime  @updatedAt @map("updated_at")
//
//   homeGames       Game[]    @relation("HomeTeam")
//   awayGames       Game[]    @relation("AwayTeam")
//
//   @@map("schools")
//   @@index([key])
//   @@index([classification])
//   @@index([conference])
// }

// ========================================
// MODEL 1: User (Authentication)
// ========================================
model User {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email         String   @unique
  passwordHash  String   @map("password_hash")
  name          String
  role          String   @default("COACH") // 'ADMIN', 'COACH', or 'WRITER'

  // Coach-specific fields
  schoolName    String?  @map("school_name")
  primarySport  String?  @map("primary_sport")
  verifiedAt    DateTime? @map("verified_at")

  // Press Box AI fields (for writers)
  writerStyleNotes String? @map("writer_style_notes") @db.Text

  // Relations
  submissions   Submission[]
  conversations Conversation[] // Press Box AI
  articles      Article[]      // Press Box AI

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  @@map("users")
  @@index([email])
  @@index([role])
  @@index([schoolName])
  @@index([verifiedAt])
}

// ========================================
// MODEL 2: Submission (Upload Session)
// ========================================
model Submission {
  id               String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId           String    @map("user_id") @db.Uuid
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  sport            String    // "BASKETBALL", "FOOTBALL", etc.
  status           String    @default("DRAFT") // 'DRAFT', 'PROCESSING', 'COMPLETED', 'FAILED'

  // Image storage (Sanity CDN URLs)
  imageUrl         String    @map("image_url")
  imageAssetId     String?   @map("image_asset_id")

  // AI extraction (full JSON response from Claude)
  rawAiResponse    Json?     @map("raw_ai_response")
  processingTimeMs Int?      @map("processing_time_ms")

  // Relations
  game             Game?

  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@map("submissions")
  @@index([userId])
  @@index([status])
  @@index([sport])
  @@index([createdAt])
}

// ========================================
// MODEL 3: Game (Approved Game Data - Maps to existing Supabase games table)
// ========================================
model Game {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Existing Supabase fields
  date            DateTime  @db.Date
  sport           String
  homeTeamId      String?   @map("home_team_id") @db.Uuid
  awayTeamId      String?   @map("away_team_id") @db.Uuid
  homeScore       Int?      @map("home_score")
  awayScore       Int?      @map("away_score")
  status          String?
  source          String?
  gender          String?

  // ScoreSnap enhancement fields
  submissionId    String?   @unique @map("submission_id") @db.Uuid
  submission      Submission? @relation(fields: [submissionId], references: [id], onDelete: Restrict)

  quarterScores   Json?     @map("quarter_scores") // [[Q1_home, Q1_away], ...]
  overtime        Boolean   @default(false)
  gameData        Json?     @map("game_data") // Complete player stats from AI
  editableUntil   DateTime? @map("editable_until")
  approvedBy      String?   @map("approved_by") @db.Uuid

  // Relations
  editHistory     EditHistory[]

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  @@map("games")
  @@index([sport])
  @@index([date])
  @@index([sport, date])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([submissionId])
  @@index([editableUntil])
  @@index([deletedAt])
}

// ========================================
// MODEL 4: ValidationError (AI Quality Tracking)
// ========================================
model ValidationError {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  submissionId    String    @map("submission_id") @db.Uuid

  errorCode       String    @map("error_code")
  errorMessage    String    @map("error_message")
  fieldPath       String?   @map("field_path")

  // Coach override
  overridden      Boolean   @default(false)
  overrideReason  String?   @map("override_reason")

  createdAt       DateTime  @default(now()) @map("created_at")

  @@map("validation_errors")
  @@index([submissionId])
  @@index([errorCode])
  @@index([createdAt])
}

// ========================================
// MODEL 5: EditHistory (Field-Level Changes)
// ========================================
model EditHistory {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  gameId          String    @map("game_id") @db.Uuid
  game            Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)

  editedBy        String    @map("edited_by") @db.Uuid
  editedAt        DateTime  @default(now()) @map("edited_at")

  fieldPath       String    @map("field_path")
  oldValue        String?   @map("old_value")
  newValue        String?   @map("new_value")

  @@map("edit_history")
  @@index([gameId])
  @@index([editedAt])
  @@index([fieldPath])
}

// ========================================
// PRESS BOX AI MODELS
// ========================================

// ========================================
// MODEL 6: Conversation (Voice Interview Session)
// ========================================
model Conversation {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  sport        String   @default("football") // football, basketball, soccer, etc.

  // Game info (proper columns for queryability)
  homeTeam     String   @map("home_team")
  awayTeam     String   @map("away_team")
  homeScore    Int?     @map("home_score")
  awayScore    Int?     @map("away_score")
  gameDate     DateTime @map("game_date")
  location     String?

  // Transcript (JSON only because it's truly variable-length array)
  // Format: [{role: "user"|"assistant", content: string, timestamp: string}]
  transcript   Json

  completed    Boolean  @default(false)

  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  articles     Article[]

  @@map("conversations")
  @@index([userId, createdAt])
  @@index([completed])
  @@index([sport, gameDate])
}

// ========================================
// MODEL 7: Article (Generated Article Draft)
// ========================================
model Article {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  conversationId String    @map("conversation_id") @db.Uuid
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  userId         String    @map("user_id") @db.Uuid
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  headline       String
  bodyMarkdown   String    @map("body_markdown") @db.Text

  published      Boolean   @default(false)
  editCount      Int       @default(0) @map("edit_count")

  createdAt      DateTime  @default(now()) @map("created_at")
  publishedAt    DateTime? @map("published_at")

  @@map("articles")
  @@index([userId, createdAt])
  @@index([conversationId])
  @@index([published])
}
